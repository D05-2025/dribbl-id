{# matches/templates/matches/match_schedule.html #}
{% extends "base.html" %}
{% block content %}

<div class="max-w-4xl mx-auto px-4 py-6">
  <div class="flex items-center justify-between mb-4">
    <h1 class="text-2xl font-bold text-white">Jadwal Pertandingan</h1>
    {% if request.user.is_authenticated %}
    <button id="btnAddMatch"
      class="inline-flex items-center rounded-md bg-blue-600 px-3 py-2 text-sm font-medium text-white hover:bg-blue-700">
      + Tambah Match
    </button>
    {% endif %}
  </div>

  <div id="matchList" class="space-y-4">
    {% for m in matches %}
      {% include "matches/_match_row.html" with m=m %}
    {% empty %}
      <div class="bg-neutral-950 border border-neutral-800 rounded-xl p-8 text-center">
        <p class="text-neutral-400">Belum ada pertandingan yang dijadwalkan.</p>
        <a href="{% url 'matches:create' %}"
           class="inline-flex items-center mt-4 rounded-md bg-blue-600 px-4 py-2 text-sm font-medium text-white hover:bg-blue-700 transition">
          Buat Pertandingan Pertama
        </a>
      </div>
    {% endfor %}
  </div>
</div>

{# Modal container #}
<div id="modalAddMatch" class="fixed inset-0 z-50 hidden">
  <div class="absolute inset-0 bg-black/60 backdrop-blur-sm" data-close-modal></div>
  <div class="relative mx-auto mt-20 w-[92%] max-w-xl rounded-2xl border border-neutral-800 bg-neutral-950 p-5">
    <h2 class="text-lg font-semibold text-white mb-3">Tambah Match</h2>
    <div id="modalBody">
      <div class="text-neutral-400">Memuat formulirâ€¦</div>
    </div>
  </div>
</div>

<script>
(function(){
  const btn = document.getElementById('btnAddMatch');
  const modal = document.getElementById('modalAddMatch');
  const modalBody = document.getElementById('modalBody');
  const list = document.getElementById('matchList');

  function csrfToken(){
    const m = document.cookie.match(/csrftoken=([^;]+)/);
    return m ? m[1] : '';
  }

  function openModal(){
    modal.classList.remove('hidden');
  }
  function closeModal(){
    modal.classList.add('hidden');
  }
  document.addEventListener('click', (e)=>{
    if (e.target.closest('[data-close-modal]')) closeModal();
  });

  // Load form via AJAX (GET)
  if (btn){
    btn.addEventListener('click', async ()=>{
      openModal();
      try{
        const res = await fetch("{% url 'matches:create' %}", {
          headers: {"X-Requested-With":"XMLHttpRequest"}
        });
        const data = await res.json();
        modalBody.innerHTML = data.html_form || '<p class="text-red-400">Gagal memuat form.</p>';
      }catch(err){
        modalBody.innerHTML = '<p class="text-red-400">Gagal memuat form.</p>';
      }
    });
  }

  // Handle submit via event delegation
  document.addEventListener('submit', async (e)=>{
    if (e.target && e.target.id === 'matchForm'){
      e.preventDefault();
      const form = e.target;
      const formData = new FormData(form);
      try{
        const res = await fetch(form.action, {
          method: 'POST',
          headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'X-CSRFToken': csrfToken()
          },
          body: formData
        });
        const data = await res.json();
        if (res.ok && data.ok){
          // sisipkan row baru ke atas list
          if (data.row_html){
              const temp = document.createElement('div');
              temp.innerHTML = data.row_html.trim();
              const child = temp.firstElementChild;
              if (child) list.insertBefore(child, list.firstChild);
            }
          closeModal();
        } else {
          // render ulang form dengan error
          if (data.html_form) modalBody.innerHTML = data.html_form;
          else modalBody.innerHTML = '<p class="text-red-400">Validasi gagal.</p>';
        }
      }catch(err){
        modalBody.innerHTML = '<p class="text-red-400">Terjadi kesalahan.</p>';
      }
    }
  });
})();
</script>

{% endblock %}
