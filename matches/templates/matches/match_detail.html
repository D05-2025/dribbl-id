{% extends 'base.html' %}
{% load static %}

{% block meta %}
<title>{{ match.home_team }} vs {{ match.away_team }} | DRIBBL.ID</title>
{% endblock meta %}

{% block content %}

{# ==== HERO FULL-BLEED (gambar span kiri–kanan) ==== #}
{% if match.image_url %}
<section class="relative w-full min-h-[320px] md:min-h-[460px] overflow-hidden">
  <img
    src="{{ match.image_url }}"
    alt="Gambar {{ match.home_team }} vs {{ match.away_team }}"
    class="absolute inset-0 w-full h-full object-cover pointer-events-none"
    loading="lazy"
    decoding="async"
  />
  <div class="absolute inset-0 bg-gradient-to-b from-black/20 via-black/20 to-black/40 pointer-events-none" aria-hidden="true"></div>

  <div class="absolute left-4 right-4 bottom-4 md:left-8 md:right-8 md:bottom-8">
    <div class="inline-flex items-center gap-2 text-white/90">
      <span class="text-sm md:text-base font-semibold">
        {{ match.home_team }} vs {{ match.away_team }}
      </span>
    </div>
  </div>
</section>
{% endif %}

{# ==== KONTEN LAINNYA (container biasa) ==== #}
<div class="relative z-10 max-w-4xl mx-auto px-4 py-8 space-y-6">

  {# Header + info singkat #}
  <section class="bg-neutral-950 border border-neutral-800 rounded-2xl p-6 text-neutral-200">
    <h1 class="text-2xl md:text-3xl font-bold text-white mb-2">
      {{ match.home_team }} vs {{ match.away_team }}
    </h1>

    <div class="text-sm md:text-base text-neutral-400 space-y-1">
      <p><strong>Tip-off:</strong> {{ match.tipoff_at|date:"M d, Y" }} • {{ match.tipoff_at|time:"H:i" }}</p>
      {% if match.venue %}<p><strong>Venue:</strong> {{ match.venue }}</p>{% endif %}
    </div>

    <div class="mt-3">
      <span class="rounded-full px-2.5 py-1 text-xs font-semibold bg-neutral-800 text-neutral-300 border border-neutral-700">
        {{ match.get_status_display }}
      </span>
    </div>

    <div class="mt-4 text-xl font-semibold text-white">
      <span class="text-blue-400">{{ match.home_team }}</span>
      <span class="mx-2">{{ match.home_score|default:"0" }}</span>
      <span class="text-neutral-500">-</span>
      <span class="mx-2">{{ match.away_score|default:"0" }}</span>
      <span class="text-red-400">{{ match.away_team }}</span>
    </div>

    {# === OPSI AKSI === #}
    <div class="mt-5 flex flex-wrap gap-2">
      {% if request.user.is_authenticated %}
        <a href="{% url 'matches:score' match.pk %}"
           class="inline-flex items-center rounded-md bg-blue-600 px-3 py-2 text-sm font-medium text-white hover:bg-blue-700 transition">
          Update Skor
        </a>
        <button type="button"
                id="btnEditMatch"
                class="inline-flex items-center rounded-md border border-neutral-700 px-3 py-2 text-sm font-medium text-neutral-200 hover:bg-neutral-700 transition">
          Edit Match
        </button>
        <a href="{% url 'matches:delete' match.pk %}"
           class="inline-flex items-center rounded-md bg-red-900 border border-red-800 px-3 py-2 text-sm font-medium text-red-200 hover:bg-red-800 transition">
          Hapus Match
        </a>
      {% endif %}
      <a href="{% url 'matches:schedule' %}"
        class="inline-flex items-center rounded-md text-sm font-medium text-neutral-400 hover:text-neutral-200 transition">
        ← Kembali ke Jadwal
      </a>
    </div>
  </section>

  {# Deskripsi match #}
  <section class="bg-neutral-950 border border-neutral-800 rounded-2xl p-6 text-neutral-200">
    <h3 class="text-lg font-semibold text-white mb-4">Deskripsi Pertandingan</h3>
    <div class="text-neutral-300 leading-relaxed">
      <p>
        Pertandingan antara
        <strong class="text-blue-400">{{ match.home_team }}</strong>
        melawan
        <strong class="text-red-400">{{ match.away_team }}</strong>
        akan berlangsung pada {{ match.tipoff_at|date:"l, M d, Y" }} pukul {{ match.tipoff_at|time:"H:i" }}.
      </p>

      {% if match.status == 'finished' %}
        <p class="mt-3">Pertandingan telah selesai dengan skor akhir <strong>{{ match.home_score }}-{{ match.away_score }}</strong>.</p>
      {% elif match.status == 'live' %}
        <p class="mt-3 text-green-400">Pertandingan sedang berlangsung dengan skor sementara <strong>{{ match.home_score }}-{{ match.away_score }}</strong>.</p>
      {% else %}
        <p class="mt-3">Pertandingan dijadwalkan akan dimulai dalam waktu dekat.</p>
      {% endif %}

      {% if match.venue %}
        <p class="mt-3">Lokasi pertandingan: <strong>{{ match.venue }}</strong></p>
      {% endif %}
    </div>
  </section>

</div>

{# ===== Modal container (dibuat di template agar pasti ada) ===== #}
<div id="editMatchModal" class="fixed inset-0 z-50 hidden" aria-hidden="true">
  <div class="absolute inset-0 bg-black/60 backdrop-blur-sm" data-close-modal></div>
  <div class="relative mx-auto mt-20 w-[92%] max-w-xl rounded-2xl border border-neutral-800 bg-neutral-950 p-5">
    <h2 class="text-lg font-semibold text-white mb-3">Edit Match</h2>
    <div id="editModalBody">
      <div class="text-neutral-400">Memuat formulir…</div>
    </div>
  </div>
</div>

{# ===== JS: diletakkan PALING AKHIR agar elemen sudah ada ===== #}
<script>
  (function(){
    window.matchId = "{{ match.pk }}";

    const btnEdit = document.getElementById('btnEditMatch');
    const modal = document.getElementById('editMatchModal');
    const modalBody = modal ? modal.querySelector('#editModalBody') : null;

    function csrfToken(){
      const m = document.cookie.match(/csrftoken=([^;]+)/);
      return m ? m[1] : '';
    }
    function openModal(){ modal.classList.remove('hidden'); }
    function closeModal(){ modal.classList.add('hidden'); }

    if (modal){
      modal.addEventListener('click', (e)=>{
        if (e.target.closest('[data-close-modal]')) closeModal();
      });
    }

    // Load edit form via AJAX (GET)
    if (btnEdit && modalBody){
      btnEdit.addEventListener('click', async ()=>{
        openModal();
        modalBody.innerHTML = '<div class="text-neutral-400">Memuat formulir…</div>';
        try{
          const res = await fetch("{% url 'matches:edit' match.pk %}", {
            headers: {"X-Requested-With":"XMLHttpRequest"},
            credentials: 'same-origin'
          });
          if (res.redirected){
            // Kemungkinan diarahkan ke login
            window.location.href = res.url;
            return;
          }
          const data = await res.json();
          modalBody.innerHTML = data.html_form || '<p class="text-red-400">Gagal memuat form.</p>';
        }catch(err){
          console.error(err);
          modalBody.innerHTML = '<p class="text-red-400">Gagal memuat form.</p>';
        }
      });
    }

    // Handle submit via event delegation (POST)
    document.addEventListener('submit', async (e)=>{
      if (e.target && e.target.id === 'matchForm'){
        e.preventDefault();
        const form = e.target;
        const formData = new FormData(form);
        try{
          const res = await fetch(form.action, {
            method: 'POST',
            headers: {
              'X-Requested-With': 'XMLHttpRequest',
              'X-CSRFToken': csrfToken()
            },
            body: formData,
            credentials: 'same-origin'
          });

          if (res.redirected){
            window.location.href = res.url;
            return;
          }

          const data = await res.json();
          if (res.ok && data.ok){
            closeModal();
            window.location.reload();
          } else {
            if (data.html_form) modalBody.innerHTML = data.html_form;
            else modalBody.innerHTML = '<p class="text-red-400">Validasi gagal.</p>';
          }
        }catch(err){
          console.error(err);
          modalBody.innerHTML = '<p class="text-red-400">Terjadi kesalahan.</p>';
        }
      }
    });
  })();
</script>
{% endblock content %}
